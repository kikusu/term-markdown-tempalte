<script type="text/javascript">

    $("h1").addClass("title");
    $("h2").addClass("chapter");
    $("h3").addClass("sub-chapter");
    $("h4").addClass("section");

    //
    var title = "";
    var chapter_idx = 0;
    var chapter = "";
    var sub_chapter_idx = 0;
    var sub_chapter = "";
    var section_idx = 0;
    var section = "";

    var id_preffix = "";

    $("h1.title, h2.chapter, h3.sub-chapter, h4.section").each(function (idx, element) {
        if (element.tagName === "H1") {
            chapter_idx = 0;
            sub_chapter_idx = 0;
            section_idx = 0;

            title = $(element).text();
        } else if (element.tagName === "H2") {
            sub_chapter_idx = 0;

            chapter = $(element).text();
            chapter_idx = chapter_idx + 1;

            id_preffix = title + "_" + chapter;

            $(element).attr("title", title);

            $(element).attr("chapter-idx", chapter_idx);

            $(element).prepend("第" + chapter_idx + "章 ");
            $(element).attr("id", id_preffix)

        } else if (element.tagName === "H3") {
            sub_chapter_idx = sub_chapter_idx + 1;
            sub_chapter = $(element).text();

            $(element).attr("title", title);

            id_preffix = title;

            if (chapter_idx > 0) {
                $(element).attr("chapter", chapter);
                $(element).attr("chapter-idx", chapter_idx);

                id_preffix = id_preffix + "_" + chapter;
            }

            $(element).attr("sub-chapter-idx", sub_chapter_idx);
            $(element).prepend("第" + sub_chapter_idx + "節 ");

            $(element).attr("id", id_preffix + "_" + sub_chapter);

        } else {
            section_idx = section_idx + 1;
            section = $(element).text();

            id_preffix = title;


            if (chapter_idx > 0) {
                $(element).attr("chapter", chapter);
                $(element).attr("chapter-idx", chapter_idx);

                id_preffix = id_preffix + "_" + chapter;
            }
            if (sub_chapter_idx > 0) {
                $(element).attr("sub-chapter", sub_chapter);
                $(element).attr("sub-chapter-idx", sub_chapter_idx);

                id_preffix = id_preffix + "_" + sub_chapter;
            }

            $(element).attr("section_idx", section_idx);
            $(element).prepend("第" + section_idx + "条 ");
            $(element).attr("id", id_preffix + "_" + section);
        }
    });

    $("a[href='']").each(function(i, element) {
        var q = $(element).text();

        var target = $("#" + q);

        console.info(target);

        if(target[0]){

            var title = target.attr("title");
            var chapter_idx = target.attr("chapter-idx");
            var sub_chapter_idx = target.attr("sub-chapter-idx");
            var section_idx = target.attr("section-idx");

            console.info(title, chapter_idx, sub_chapter_idx, section_idx);


            var link_text = title;
            if(chapter_idx){
                link_text = link_text + "第 " + chapter_idx + " 章";
            }
            if(sub_chapter_idx){
                link_text = link_text + "第 " + sub_chapter_idx + " 節";
            }
            if(section_idx){
                link_text = link_text + "第 " + section_idx + " 条";
            }
            $(element).text(link_text);
            $(element).attr("href", "#" + q);
        }
        else{
            console.info("Inline Link #" + q + " not found.")
        }

    });
</script>


